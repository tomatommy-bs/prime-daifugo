# Getting Started

- hosting サーバーと、websocket サーバーを立ち上げる

```bash
npm run dev
npm run dev:pk
```

# 素数大富豪のルール

https://primeqk.themedia.jp/pages/4500251/rules

## ルールのポイント（概略）

- 手札のカードを組み合わせて「素数」を作って出していき、早く手札をなくした人の勝ち
- カードの数字を並べて読み、ひとつの数として取り扱う
- 前の人が出した数と同じ枚数で、より大きな数を作って出さなければならない

## 基本ルール

- **勝利条件：** 参加プレイヤーの中で最も早く手札をなくす（出しきる）こと。
- **カードの扱い：** \[A]=1, \[J]=11, \[Q]=12, \[K]=13 として扱う。
- **数の作り方：** 2枚以上のカードを組み合わせて数を作る際は、カードに書かれた数を並べてひとつの数として扱う。 例：\\[Q]\[A] → 6,121（4桁の数）
- **手札を増やす：** 自分の手番では、山札の上から1枚までカードを引いて手札に加えることができる。

## 特殊ルール

- **ジョーカー：** 1枚出しでは13（K）に勝つものとして出すことができ、さらに出すと場を流すことができる。 他のカードと組み合わせて2枚以上で出す際は、0～13のいずれかの数として使う。（出す際にどの数として出すのかを宣言する。）
- **57【グロタンディーク素数切り】：** 57は「グロタンディーク素数」と呼ばれる特別な数で、出すと場を流すことができる。
- **1729【ラマヌジャン革命】：** 1729は特別な数で、出すと「ラマヌジャン革命」が起きる。 革命下では、数の大小判定が逆転する。 効果は、再度ラマヌジャン革命が起こる（場に1729が出される）まで続く。
- **合成数出し:** 合成数は、その数とともに素因数分解の式を作って一緒に出すことで、場に出すことができる。 素因数に使った札は即座に流れ、場には出された合成数のみが残る。

## 素数大富豪の遊び方［トランプで遊ぶ場合］

**［用意するもの：トランプ1組（54枚）、対戦相手（1～5人程度）、素数判定員（または素数判定アプリ等）］**

1.  トランプをよくきり、各プレイヤーに手札を11枚（原則は素数枚。5枚/7枚でもよい）ずつ配る。 残ったカードは、山札として場の中央に裏向きに積んでおく。
2.  ジャンケン等で順番を決める。
3.  プレイヤーは、自分の手番中に以下のことができる。
    - ① 手札を増やしたい場合は、山札からカードを1枚引いて手札に加えることができる（任意）。
    - ② 場に出ている数と同じ枚数の手札を組み合わせて、場に出ている数より大きな素数を作って場に出す。
      - ※ 場に数が出ていない時は、好きな枚数で出してよい
      - ※ 出す数ははっきりと宣言すること（並び順により異なる数となるため）
    - ③ 出せるものがない場合や出したくない場合は、「パス」を宣言する。
4.  場に数が出されたら、その数が素数であるかどうかを素数判定員が確認する。
    - ※ 素数判定員はプレイヤーが兼任してもよい
5.  出した数が素数でなかった場合は、ペナルティとして出した札を手札に戻し、さらに同じ枚数だけ山札からカードを引く。
6.  場に出された数が更新されないまま手番が一周したら、場のカードを流して、最後の数を出したプレイヤーの手番になる。
7.  これを繰り返して、より早く手札を出しきったプレイヤーの勝ちとなる。

# アーキテクチャ

## 概要

このプロジェクトは Next.js ベースのフロントエンドと PartyKit による WebSocket サーバーを組み合わせたリアルタイムマルチプレイヤーゲームアプリケーションです。

## 技術スタック

### フロントエンド
- **Next.js 14**: App Router を使用したモダンな React フレームワーク
- **Mantine**: UI コンポーネントライブラリ
- **Tailwind CSS + DaisyUI**: スタイリング
- **TypeScript**: 型安全性の確保
- **Framer Motion**: アニメーション
- **Zod**: スキーマバリデーション

### バックエンド
- **PartyKit**: リアルタイム WebSocket サーバー
- **boardgame.io**: ゲーム状態管理（部分的に使用）
- **primes-and-factors**: 素数計算ライブラリ

### 開発・テスト環境
- **Biome**: リンティング・フォーマッティング
- **Jest + React Testing Library**: ユニットテスト
- **Vitest**: 追加のテスト環境
- **Storybook**: コンポーネント開発

## ディレクトリ構造と役割

```
src/
├── app/                    # Next.js App Router ページ
│   ├── room/[id]/         # ゲームルーム関連ページ
│   └── login/             # ログイン機能
├── components/            # 再利用可能なReactコンポーネント
├── constants/             # アプリケーション定数
├── game-card/             # カードゲーム専用コンポーネント
│   └── src/
│       ├── components/    # カードコンポーネント
│       └── icons/         # 全54枚のカードアイコン
├── hooks/                 # カスタムReactフック
├── interface/             # 型定義・通信インターフェース
│   ├── client-to-server.ts
│   ├── server-to-client.ts
│   └── common.ts
├── partykit/              # WebSocketサーバーロジック
│   ├── lobby/             # ロビー管理
│   ├── room/              # ゲームルーム管理
│   │   └── logic/         # ゲームルール・状態管理
│   └── main.ts            # PartyKitエントリーポイント
└── utils/                 # ユーティリティ関数
```

## 開発上の利点

### 1. モジュラー設計
- **分離された関心事**: フロントエンド（Next.js）とリアルタイム通信（PartyKit）の明確な分離
- **再利用可能なコンポーネント**: `game-card/` パッケージによる独立したカードシステム
- **型安全な通信**: `interface/` による厳密な型定義

### 2. スケーラブルな開発環境
- **TypeScript**: 型安全性による早期バグ発見
- **Biome**: 高速なリンティング・フォーマッティング
- **Storybook**: 分離された環境でのコンポーネント開発
- **テスト環境**: Jest + Vitest による包括的なテスト

### 3. リアルタイム機能
- **PartyKit**: 簡単な WebSocket サーバー構築
- **状態同期**: サーバー・クライアント間の自動的な状態同期
- **ルーム管理**: 動的なゲームルーム作成・管理

### 4. ゲーム特化機能
- **素数計算**: `primes-and-factors` による高速な素数判定
- **カードシステム**: 全54枚のカードを網羅した型安全なシステム
- **ゲームルール**: モジュール化されたゲームロジック（`src/partykit/room/logic/`）

### 5. 開発効率化
```bash
# 開発サーバー起動（並行実行）
npm run dev      # Next.js開発サーバー
npm run dev:pk   # PartyKit開発サーバー

# コード品質管理
npm run biome    # リンティング・フォーマット
npm run test     # テスト実行

# ストーリーブック
npm run storybook # コンポーネント開発環境
```

### 6. デプロイメント
- **Vercel**: フロントエンドの自動デプロイ
- **PartyKit Cloud**: WebSocketサーバーの管理デプロイ
- **一括デプロイ**: `npm run deploy` による統合デプロイ
